<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logvault Alarms</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 2rem;
        }
        .card-header {
            font-size: 1.25rem;
            font-weight: 500;
        }
        #loading {
            text-align: center;
            padding: 2rem;
            font-style: italic;
        }
        .details-row > td {
            background-color: #fdfdfd;
        }
        td.details-control {
            background: url('https://datatables.net/examples/resources/details_open.png') no-repeat center center;
            cursor: pointer;
        }
        tr.details td.details-control {
            background: url('https://datatables.net/examples/resources/details_close.png') no-repeat center center;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #threat-alarms-table td, #alarms-table td {
            word-break: break-all;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Logvault Alarms</a>
            <div>
                <button id="refreshBtn" class="btn btn-primary">Refresh</button>
                <button id="deleteAllBtn" class="btn btn-danger">Delete All</button>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </nav>

    <main class="container-fluid">
        <div id="threat-alarms-container" class="card shadow-sm mb-4" style="display: none;">
            <div class="card-header">
                Threat Alarms
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="threat-alarms-table" class="table table-striped table-bordered" style="width:100%">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="alarms-container" class="card shadow-sm">
            <div class="card-header">
                Other Alarms
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="alarms-table" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th></th>
                                <th>TAG</th>
                                <th>Alarm Message</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <p id="loading">Loading alarms...</p>
    </main>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function() {
            const loading = $('#loading');

            // Destroy existing DataTables instances if they exist
            if ($.fn.DataTable.isDataTable('#threat-alarms-table')) {
                $('#threat-alarms-table').DataTable().destroy();
            }
            if ($.fn.DataTable.isDataTable('#alarms-table')) {
                $('#alarms-table').DataTable().destroy();
            }

            const fetchAlarms = () => {
                loading.show();
                $.ajax({
                    url: '/api/alarms',
                    method: 'GET',
                    success: function(alarms) {
                        renderAlarms(alarms);
                        loading.hide();
                    },
                    error: function(xhr, status, error) {
                        loading.text('Failed to load alarms.').show();
                        console.error('Fetch error:', error);
                    }
                });
            };

            const renderAlarms = (alarms) => {
                const threatAlarms = {};
                const otherAlarms = {};

                for (const key in alarms) {
                    const alarmData = alarms[key];
                    if (typeof alarmData === 'object' && alarmData !== null && alarmData.tag === 'Insights') {
                        threatAlarms[key] = { ...alarmData, original_key: key };
                    } else {
                        otherAlarms[key] = { data: alarmData, original_key: key };
                    }
                }
                
                renderThreatAlarms(Object.values(threatAlarms));
                renderOtherAlarms(Object.values(otherAlarms));

                if (Object.keys(alarms).length === 0) {
                    loading.text('No active alarms found.').show();
                } else {
                    loading.hide();
                }
            };
            
            const renderThreatAlarms = (threatAlarms) => {
                const container = $('#threat-alarms-container');
                if (threatAlarms.length > 0) {
                    container.show();

                    const headerSet = new Set();
                    threatAlarms.forEach(alarm => {
                        Object.keys(alarm).forEach(header => {
                            if(header !== 'original_key') headerSet.add(header);
                        });
                    });
                    const headers = Array.from(headerSet);

                    let thead = '<tr><th></th>'; // Add empty header for details control
                    headers.forEach(header => thead += `<th>${header}</th>`);
                    thead += '<th>Action</th></tr>';
                    $('#threat-alarms-table thead').html(thead);

                    if ($.fn.DataTable.isDataTable('#threat-alarms-table')) {
                        $('#threat-alarms-table').DataTable().clear().destroy();
                    }

                    const threatTable = $('#threat-alarms-table').DataTable({
                        data: threatAlarms,
                        columns: [
                            {
                                className: 'details-control',
                                orderable: false,
                                data: null,
                                defaultContent: ''
                            },
                            ...headers.map(header => ({ data: header, defaultContent: 'N/A' })),
                            {
                                data: 'original_key',
                                render: function(data, type, row) {
                                    return `<button class="btn btn-danger btn-sm delete-btn" data-key="${escapeHtml(data)}">Delete</button>`;
                                },
                                orderable: false
                            }
                        ],
                        responsive: true,
                        "bDestroy": true
                    });

                    // Add event listener for opening and closing details
                    $('#threat-alarms-table tbody').off('click', 'td.details-control').on('click', 'td.details-control', function () {
                        var tr = $(this).closest('tr');
                        var row = threatTable.row(tr);

                        if (row.child.isShown()) {
                            // This row is already open - close it
                            row.child.hide();
                            tr.removeClass('details');
                        } else {
                            // Open this row
                            const rowData = row.data();
                            const formattedData = JSON.stringify(rowData, null, 2);
                            row.child($('<pre>').text(formattedData)).show();
                            tr.addClass('details');
                        }
                    });
                } else {
                    container.hide();
                }
            };

            const renderOtherAlarms = (otherAlarms) => {
                 const container = $('#alarms-container');
                 if (otherAlarms.length > 0) {
                    container.show();
                    if ($.fn.DataTable.isDataTable('#alarms-table')) {
                        $('#alarms-table').DataTable().clear().destroy();
                    }

                    const otherTable = $('#alarms-table').DataTable({
                        data: otherAlarms,
                        columns: [
                            {
                                className: 'details-control',
                                orderable: false,
                                data: null,
                                defaultContent: ''
                            },
                            { 
                                data: 'data.tag', 
                                defaultContent: 'N/A',
                                render: function(data, type, row) {
                                    return escapeHtml(data);
                                }
                            },
                                                        {
                                data: 'data',
                                render: function(data, type, row) {
                                    if (typeof data !== 'object' || data === null) {
                                        return escapeHtml(String(data));
                                    }
                                    return escapeHtml(data.message || data.field_0 || JSON.stringify(data).substring(0, 100) + '...');
                                }
                            },
                            {
                                data: 'original_key',
                                render: function(data, type, row) {
                                    return `<button class="btn btn-danger btn-sm delete-btn" data-key="${escapeHtml(data)}">Delete</button>`;
                                },
                                orderable: false
                            }
                        ],
                        "bDestroy": true
                    });

                    // Add event listener for opening and closing details
                    $('#alarms-table tbody').off('click', 'td.details-control').on('click', 'td.details-control', function () {
                        var tr = $(this).closest('tr');
                        var row = otherTable.row(tr);

                        if (row.child.isShown()) {
                            // This row is already open - close it
                            row.child.hide();
                            tr.removeClass('details');
                        } else {
                            // Open this row
                            const rowData = row.data();
                            const formattedData = JSON.stringify(rowData.data, null, 2);
                            row.child($('<pre>').text(formattedData)).show();
                            tr.addClass('details');
                        }
                    });
                } else {
                     container.hide();
                }
            };

            const deleteAlarm = (key) => {
                if (!confirm(`Are you sure you want to delete the alarm for ${key}?`)) {
                    return;
                }
                $.ajax({
                    url: `/api/alarms/${key}`,
                    method: 'DELETE',
                    success: function() {
                        fetchAlarms();
                    },
                    error: function() {
                        alert('Failed to delete alarm.');
                    }
                });
            };

            $('#threat-alarms-table, #alarms-table').on('click', '.delete-btn', function(event) {
                event.stopPropagation();
                const key = $(this).data('key');
                deleteAlarm(key);
            });

            function escapeHtml(unsafe) {
                const str = String(unsafe);
                return str
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
            
            $('#refreshBtn').on('click', fetchAlarms);
            
            $('#logoutBtn').on('click', () => {
                window.location.href = '/logout';
            });

            const deleteAllAlarms = () => {
                if (!confirm('Are you sure you want to delete ALL alarms? This action cannot be undone.')) {
                    return;
                }
                $.ajax({
                    url: '/api/alarms',
                    method: 'DELETE',
                    success: function() {
                        fetchAlarms(); // Refresh the table
                    },
                    error: function() {
                        alert('Failed to delete all alarms.');
                    }
                });
            };

            $('#deleteAllBtn').on('click', deleteAllAlarms);

            // Initial fetch
            fetchAlarms();
        });
    </script>
</body>
</html>